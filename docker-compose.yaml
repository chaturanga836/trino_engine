version: "3.9"

services:

  # üîê Generate TLS keystore for Trino
  trino-certgen:
    image: eclipse-temurin:17-jdk
    container_name: trino-certgen
    volumes:
      - trino-certs:/certs
    entrypoint: >
      sh -c "
      if [ ! -f /certs/keystore.jks ]; then
        echo 'Generating Trino TLS keystore';
        keytool -genkeypair
          -alias trino
          -keyalg RSA
          -keysize 2048
          -validity 3650
          -keystore /certs/keystore.jks
          -storepass changeit
          -keypass changeit
          -dname 'CN=trino';
      fi"

  # üê≥ Trino service
  trino:
    image: trinodb/trino:477
    container_name: trino
    hostname: trino
    depends_on:
      - trino-certgen
      - auth-service
    ports:
      - "4001:8443"
    volumes:
      # Main config
      - /home/ubuntu/trino_engine/config:/etc/trino
      # Ranger plugin
      - /home/ubuntu/trino_engine/config/plugin:/usr/lib/trino/plugin/ranger
      # Keystore volume
      - trino-certs:/certs
    environment:
      - CATALOG_MANAGEMENT=dynamic
    healthcheck:
      test: ["CMD", "curl", "-k", "https://localhost:8443/v1/info"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - trino-ranger-net
      - ldap_service_ldap_network

  # üõ°Ô∏è Auth-service for JWT
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: trino-auth
    ports:
      - "7000:7000"
    environment:
      - APP_ENV=prod
      - DATABASE_URL=postgresql://postgres:2324@ec2-65-0-150-75.ap-south-1.compute.amazonaws.com:5432/auth_db
      - RANGER_BASE_URL=http://65.0.150.75:6080
      - RANGER_USER=admin
      - RANGER_PASSWORD=Admin@123
      - PRIVATE_KEY_PATH=/app/keys/trino_private.pem
      - PUBLIC_KEY_PATH=/app/keys/public_key.pem
      - JWT_ISSUER=http://trino-auth:7000
    volumes:
      - ./auth-service/app/keys/trino_private.pem:/app/keys/trino_private.pem:ro
      - ./auth-service/app/keys/public_key.pem:/app/keys/public_key.pem:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - trino-ranger-net

# üîπ Volumes
volumes:
  trino-data:
  trino-certs:

# üîπ Networks
networks:
  trino-ranger-net:
    driver: bridge
  ldap_service_ldap_network:
    external: true
