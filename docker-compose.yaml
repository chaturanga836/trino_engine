version: "3.9"

services:
  # ðŸ‘‘ Trino Coordinator (The Brain)
  trino-coordinator:
    build:
      context: .
      dockerfile: Dockerfile.trino
      args:
        - CA_FILE_NAME=${CA_FILENAME}
    container_name: trino-coordinator
    hostname: trino-coordinator
    ports:
      - "8443:8443" # External HTTPS for UI/API
      - "4001:8080" # External HTTP
    environment:
      - CATALOG_MANAGEMENT=dynamic
    volumes:
      # Specific Coordinator Configs
      - ./config/coordinator/config.properties:/etc/trino/config.properties
      - ./config/coordinator/node.properties:/etc/trino/node.properties
      # Shared Configs
      - ./config/jvm.config:/etc/trino/jvm.config
      - ./config/access-control.properties:/etc/trino/access-control.properties
      # Catalogs
      - ./config/catalog:/etc/trino/catalog
      - trino-coordinator-data:/var/trino/data
    networks:
      trino-ranger-net:
        aliases:
          - trino-coordinator

  # ðŸ”¨ Trino Worker (The Muscle)
  trino-worker:
    build:
      context: .
      dockerfile: Dockerfile.trino
      args:
        - CA_FILE_NAME=${CA_FILENAME}
    container_name: trino-worker-1
    hostname: trino-worker-1
    # No ports exposed to host! Only talks to Coordinator via trino-net
    environment:
      - CATALOG_MANAGEMENT=dynamic
    depends_on:
      - trino-coordinator
    volumes:
      # Specific Worker Configs
      - ./config/worker/config.properties:/etc/trino/config.properties
      - ./config/worker/node.properties:/etc/trino/node.properties
      # Shared Configs
      - ./config/jvm.config:/etc/trino/jvm.config
      # Workers need catalogs too to fetch data
      - ./config/catalog:/etc/trino/catalog
      - trino-worker-data:/var/trino/data
      - ./trino-certs:/usr/lib/trino/certs
    networks:
          trino-ranger-net:
            aliases:
              - trino-worker-1

volumes:
  trino-coordinator-data:
  trino-worker-data:

networks:
  trino-ranger-net:
    external: true
    name: trino_engine_trino-ranger-net