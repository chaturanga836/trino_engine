version: "3.9"

services:
  # üê≥ Trino Service
  trino:
    build:
      context: .
      dockerfile: Dockerfile.trino
      args:
        # This pulls CA_FILENAME from your .env file
        - CA_FILE_NAME=${CA_FILENAME}
    container_name: trino
    hostname: trino
    ports:
      - "8443:8443" # HTTPS (OIDC Redirects)
      - "4001:8080" # HTTP
    environment:
      - CATALOG_MANAGEMENT=dynamic
    volumes:
      # Configurations
      - ./config/config.properties:/etc/trino/config.properties
      - ./config/jvm.config:/etc/trino/jvm.config
      - ./config/node.properties:/etc/trino/node.properties
      # We use file-based access control instead of OPA for now
      - ./config/access-control.properties:/etc/trino/access-control.properties
      # - ./config/rules.json:/etc/trino/rules.json
      
      # Catalogs
      - ./config/catalog/hudi.properties:/etc/trino/catalog/hudi.properties
      - ./config/catalog/hive.properties:/etc/trino/catalog/hive.properties
      
      # Data
      - trino-data:/var/trino/data
    healthcheck:
      test: ["CMD", "curl", "-k", "https://localhost:8443/v1/info"]
      interval: 10s
      timeout: 5s
    networks:
      - trino-net

# üîπ Volumes
volumes:
  trino-data:

# üîπ Networks
networks:
  trino-net:
    driver: bridge